{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì“°ë ˆê¸° ë°°ì¶œ ì•Œë¦¼</title>
    <link rel="stylesheet" href="{% static 'pages/styles.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
</head>
<body>
    <div class="min-h-screen bg-background">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="navbar-container">
                <!-- Logo -->
                <div class="navbar-logo">
                    <div class="logo-icon">
                        <i data-lucide="recycle" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="logo-text">ë²„ë¦¼</span>
                </div>
                
                <!-- Navigation Items -->
                <div class="navbar-menu">
                    <a href="{% url 'index' %}" class="nav-item active">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span>í™ˆ</span>
                    </a>
                    <a href="{% url 'calendar' %}" class="nav-item">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span>ìˆ˜ê±° ìº˜ë¦°ë”</span>
                    </a>
                    <a href="{% url 'guide' %}" class="nav-item nav-button">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                        <span>ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œ</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Compact Hero Section -->
        <section class="relative bg-gradient-hero text-white py-12">
            <div class="absolute inset-0">
                <div class="hero-image"></div>
            </div>
            <div class="relative container mx-auto px-4">
                <div class="max-w-2xl mx-auto text-center">
                    <h1 class="text-3xl md:text-4xl font-bold mb-4">
                        ìŠ¤ë§ˆíŠ¸ ì“°ë ˆê¸° ë°°ì¶œ ì•Œë¦¼
                    </h1>
                    <p class="text-base md:text-lg mb-6 opacity-90">
                        ì§€ì—­ë³„ ì“°ë ˆê¸° ìˆ˜ê±° ì¼ì •ê³¼ ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤
                    </p>
                    <div class="flex flex-wrap justify-center gap-3">
                        <span class="badge bg-white/20 text-white border-white/30 px-3 py-1">
                            <i data-lucide="calendar" class="w-3 h-3 mr-1 inline"></i>
                            ì›”ë³„ ìº˜ë¦°ë”
                        </span>
                        <span class="badge bg-white/20 text-white border-white/30 px-3 py-1">
                            <i data-lucide="recycle" class="w-3 h-3 mr-1 inline"></i>
                            ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œ
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="container mx-auto px-4 py-12">
            <div class="space-y-12">
                <!-- Region Selection -->
                <div class="flex flex-col items-center text-center">
                    <h2 class="text-2xl font-bold text-primary mb-4">
                        ê±°ì£¼ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”
                    </h2>
                    <p class="text-muted-foreground mb-8 max-w-md">
                        ì§€ì—­ë³„ ë§ì¶¤ ì“°ë ˆê¸° ìˆ˜ê±° ì¼ì •ê³¼ ë¶„ë¦¬ìˆ˜ê±° ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤
                    </p>
                    <div class="w-full max-w-md space-y-4">
                        <select id="region-select-home" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            {% for region in regions %}
                                <option value="{{ region.code }}">{{ region.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- ì•Œë¦¼ ì„¤ì • -->
                <div id="notification-settings" class="bg-card border border-accent/20 rounded-lg p-6 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                <i data-lucide="bell" class="w-5 h-5 text-primary-foreground"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-foreground">ì•Œë¦¼ ì„¤ì •</h3>
                                <p class="text-sm text-muted-foreground">ìˆ˜ê±°ì¼ ì•Œë¦¼ì„ ë°›ìœ¼ì„¸ìš”</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="notification-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div id="notification-options" class="space-y-4" style="display: none;">
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">ì•Œë¦¼ ë°›ì„ ì§€ì—­</label>
                            <select id="notification-region" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                {% for region in regions %}
                                    <option value="{{ region.code }}">{{ region.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="notify-before" checked class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                <span class="text-sm text-foreground">ìˆ˜ê±° ì „ë‚  ì•Œë¦¼</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="notify-day" checked class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                <span class="text-sm text-foreground">ìˆ˜ê±° ë‹¹ì¼ ì•Œë¦¼</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-foreground mb-2">ì•Œë¦¼ ì‹œê°„</label>
                            <input type="time" id="notification-time" value="20:00" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <button id="save-notification-btn" class="w-full btn-primary">
                            ì•Œë¦¼ ì„¤ì • ì €ì¥
                        </button>
                        <div id="notification-status" class="text-sm text-center"></div>
                    </div>
                </div>

                <!-- Quick Action Cards -->
                <div class="grid md:grid-cols-2 gap-4">
                    <a href="{% url 'calendar' %}" class="block">
                        <div class="p-4 bg-accent/10 hover:bg-accent/20 rounded-lg cursor-pointer group">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                        <i data-lucide="calendar" class="w-5 h-5 text-primary-foreground"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-foreground">ìˆ˜ê±° ìº˜ë¦°ë”</h4>
                                        <p class="text-sm text-muted-foreground">ì›”ë³„ ë°°ì¶œ ì¼ì • í™•ì¸</p>
                                    </div>
                                </div>
                                <i data-lucide="arrow-right" class="w-5 h-5 text-muted-foreground group-hover:text-primary"></i>
                            </div>
                        </div>
                    </a>
                    
                    <a href="{% url 'guide' %}" class="block">
                        <div class="p-4 bg-accent/10 hover:bg-accent/20 rounded-lg cursor-pointer group">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-waste-recyclable rounded-full flex items-center justify-center">
                                        <i data-lucide="recycle" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-foreground">ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œ</h4>
                                        <p class="text-sm text-muted-foreground">ì˜¬ë°”ë¥¸ ë¶„ë¥˜ ë°©ë²•</p>
                                    </div>
                                </div>
                                <i data-lucide="arrow-right" class="w-5 h-5 text-muted-foreground group-hover:text-primary"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="bg-secondary/30 py-12">
            <div class="container mx-auto px-4">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-3">
                        í¸ë¦¬í•œ ê¸°ëŠ¥ë“¤
                    </h2>
                    <p class="text-muted-foreground">
                        ì“°ë ˆê¸° ë°°ì¶œì„ ë”ìš± ì‰½ê³  ì •í™•í•˜ê²Œ
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="text-center p-6 bg-card rounded-lg border border-accent/20">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="calendar" class="w-6 h-6 text-primary-foreground"></i>
                        </div>
                        <h3 class="font-semibold mb-2">ì›”ë³„ ìº˜ë¦°ë”</h3>
                        <p class="text-muted-foreground text-sm">
                            í•œ ë‹¬ ì „ì²´ ìˆ˜ê±° ì¼ì •ì„ ë‹¬ë ¥ìœ¼ë¡œ í•œëˆˆì— í™•ì¸
                        </p>
                    </div>
                    <div class="text-center p-6 bg-card rounded-lg border border-accent/20">
                        <div class="w-12 h-12 bg-waste-food rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="recycle" class="w-6 h-6 text-white"></i>
                        </div>
                        <h3 class="font-semibold mb-2">ë¶„ë¦¬ìˆ˜ê±° ê°€ì´ë“œ</h3>
                        <p class="text-muted-foreground text-sm">
                            ì˜¬ë°”ë¥¸ ë¶„ë¦¬ìˆ˜ê±° ë°©ë²•ê³¼ íŒì„ ìƒì„¸íˆ ì•ˆë‚´
                        </p>
                    </div>
                    <div class="text-center p-6 bg-card rounded-lg border border-accent/20">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="bell" class="w-6 h-6 text-primary-foreground"></i>
                        </div>
                        <h3 class="font-semibold mb-2">ì•Œë¦¼ ì„œë¹„ìŠ¤</h3>
                        <p class="text-muted-foreground text-sm">
                            ìˆ˜ê±°ì¼ ì „ë‚ ê³¼ ë‹¹ì¼ ë¸Œë¼ìš°ì € ì•Œë¦¼ìœ¼ë¡œ ë†“ì¹˜ì§€ ì•Šê²Œ
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ìƒì„±
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(title, message) {
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/static/pages/favicon.ico',
                    badge: '/static/pages/favicon.ico',
                    tag: 'waste-collection',
                    requireInteraction: false
                });
            }
        }

        // ì•Œë¦¼ ì„¤ì • ì €ì¥
        async function saveNotificationSetting() {
            const enabled = document.getElementById('notification-enabled').checked;
            const region = document.getElementById('notification-region').value;
            const notifyBefore = document.getElementById('notify-before').checked;
            const notifyDay = document.getElementById('notify-day').checked;
            const notificationTime = document.getElementById('notification-time').value;

            if (enabled && !region) {
                document.getElementById('notification-status').textContent = 'ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                document.getElementById('notification-status').style.color = '#ef4444';
                return;
            }

            if (enabled) {
                const hasPermission = await requestNotificationPermission();
                if (!hasPermission) {
                    document.getElementById('notification-status').textContent = 'ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    document.getElementById('notification-status').style.color = '#ef4444';
                    document.getElementById('notification-enabled').checked = false;
                    return;
                }
            }

            const userId = getUserId();
            try {
                const response = await fetch('/api/notification/setting/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': userId
                    },
                    body: JSON.stringify({
                        region: region,
                        enabled: enabled,
                        notify_before: notifyBefore,
                        notify_day: notifyDay,
                        notification_time: notificationTime
                    })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('notification-status').textContent = 'ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    document.getElementById('notification-status').style.color = '#22c55e';
                    
                    // ì•Œë¦¼ ì²´í¬ ì‹œì‘
                    if (enabled) {
                        startNotificationCheck();
                    } else {
                        stopNotificationCheck();
                    }
                } else {
                    document.getElementById('notification-status').textContent = 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    document.getElementById('notification-status').style.color = '#ef4444';
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                document.getElementById('notification-status').textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                document.getElementById('notification-status').style.color = '#ef4444';
            }
        }

        // ì•Œë¦¼ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadNotificationSetting() {
            const userId = getUserId();
            try {
                const response = await fetch('/api/notification/setting/get/', {
                    headers: {
                        'X-User-Id': userId
                    }
                });

                const data = await response.json();
                if (data.success && data.setting) {
                    const setting = data.setting;
                    document.getElementById('notification-enabled').checked = setting.enabled;
                    document.getElementById('notification-region').value = setting.region || '';
                    document.getElementById('notify-before').checked = setting.notify_before;
                    document.getElementById('notify-day').checked = setting.notify_day;
                    document.getElementById('notification-time').value = setting.notification_time || '20:00';
                    
                    if (setting.enabled) {
                        document.getElementById('notification-options').style.display = 'block';
                        startNotificationCheck();
                    }
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            }
        }

        // ë‹¤ê°€ì˜¤ëŠ” ìˆ˜ê±°ì¼ í™•ì¸
        let notificationCheckInterval = null;
        const notifiedCollections = new Set();

        async function checkUpcomingCollections() {
            const userId = getUserId();
            try {
                const response = await fetch('/api/notification/collections/', {
                    headers: {
                        'X-User-Id': userId
                    }
                });

                const data = await response.json();
                if (data.success && data.collections) {
                    const now = new Date();
                    const currentTime = now.getHours() * 60 + now.getMinutes();
                    
                    data.collections.forEach(collection => {
                        const collectionKey = `${collection.date}_${collection.waste_type}`;
                        
                        // ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ ê²½ìš° ìŠ¤í‚µ
                        if (notifiedCollections.has(collectionKey)) {
                            return;
                        }

                        // ì•Œë¦¼ ì‹œê°„ í™•ì¸
                        const notificationTime = document.getElementById('notification-time').value;
                        const [hours, minutes] = notificationTime.split(':').map(Number);
                        const notificationMinutes = hours * 60 + minutes;
                        
                        // ì•Œë¦¼ ì‹œê°„ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸ (ì˜¤ëŠ˜ ì•Œë¦¼ì€ ì‹œê°„ ì²´í¬ ì•ˆ í•¨)
                        if (collection.days_until > 0 && currentTime < notificationMinutes) {
                            return;
                        }

                        // ì•Œë¦¼ í‘œì‹œ
                        let title, message;
                        if (collection.days_until === 0) {
                            title = 'ğŸ—‘ï¸ ì˜¤ëŠ˜ì€ ìˆ˜ê±°ì¼ì…ë‹ˆë‹¤!';
                            message = `${collection.waste_type} ìˆ˜ê±°ì¼ì…ë‹ˆë‹¤. ë°°ì¶œ ì¤€ë¹„í•˜ì„¸ìš”!`;
                        } else if (collection.days_until === 1) {
                            title = 'ğŸ—‘ï¸ ë‚´ì¼ì€ ìˆ˜ê±°ì¼ì…ë‹ˆë‹¤!';
                            message = `ë‚´ì¼ ${collection.waste_type} ìˆ˜ê±°ì¼ì…ë‹ˆë‹¤. ë¯¸ë¦¬ ì¤€ë¹„í•˜ì„¸ìš”!`;
                        } else {
                            return;
                        }

                        showNotification(title, message);
                        notifiedCollections.add(collectionKey);
                        
                        // í•˜ë£¨ê°€ ì§€ë‚˜ë©´ Setì—ì„œ ì œê±° (ë©”ëª¨ë¦¬ ê´€ë¦¬)
                        setTimeout(() => {
                            notifiedCollections.delete(collectionKey);
                        }, 24 * 60 * 60 * 1000);
                    });
                }
            } catch (error) {
                console.error('ìˆ˜ê±°ì¼ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì•Œë¦¼ ì²´í¬ ì‹œì‘
        function startNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }
            
            // ì¦‰ì‹œ í•œ ë²ˆ í™•ì¸
            checkUpcomingCollections();
            
            // 1ë¶„ë§ˆë‹¤ í™•ì¸
            notificationCheckInterval = setInterval(checkUpcomingCollections, 60000);
        }

        // ì•Œë¦¼ ì²´í¬ ì¤‘ì§€
        function stopNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
                notificationCheckInterval = null;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì•Œë¦¼ ì„¤ì • UI ì´ë²¤íŠ¸
            const notificationEnabled = document.getElementById('notification-enabled');
            const notificationOptions = document.getElementById('notification-options');
            const saveBtn = document.getElementById('save-notification-btn');

            notificationEnabled.addEventListener('change', function() {
                if (this.checked) {
                    notificationOptions.style.display = 'block';
                } else {
                    notificationOptions.style.display = 'none';
                    stopNotificationCheck();
                    saveNotificationSetting();
                }
            });

            saveBtn.addEventListener('click', saveNotificationSetting);

            // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            loadNotificationSetting();
        });
    </script>
</body>
</html>

